<?php
$pageTitle = 'ပင်မစာမျက်နှာ';
?>

<!-- Hero Section -->
<section class="hero bg-primary text-white py-5 mb-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="display-4 mb-3">2D3D ထီ</h1>
                <p class="lead mb-4">မြန်မာနိုင်ငံ၏ ယုံကြည်စိတ်ချရသော အွန်လိုင်းထီဝန်ဆောင်မှု</p>
                <a href="/play" class="btn btn-light btn-lg">ထီထိုးရန် <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="col-md-6">
                <img src="/assets/images/hero.png" alt="2D3D Lottery" class="img-fluid">
            </div>
        </div>
    </div>
</section>

<!-- Latest Results -->
<section class="latest-results mb-5">
    <div class="container">
        <h2 class="text-center mb-4">နောက်ဆုံးထွက် ထီပေါက်စဉ်များ</h2>
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">2D ထီပေါက်စဉ်</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="text-primary mb-0" id="latest2D">--</h3>
                                <small class="text-muted" id="latest2DTime">Loading...</small>
                            </div>
                            <a href="/results" class="btn btn-outline-primary">မှတ်တမ်းများ</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">3D ထီပေါက်စဉ်</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="text-success mb-0" id="latest3D">---</h3>
                                <small class="text-muted" id="latest3DTime">Loading...</small>
                            </div>
                            <a href="/results" class="btn btn-outline-success">မှတ်တမ်းများ</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features -->
<section class="features mb-5">
    <div class="container">
        <h2 class="text-center mb-4">အထူးအချက်များ</h2>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                        <h5 class="card-title">စိတ်ချရသော</h5>
                        <p class="card-text">လုံခြုံစိတ်ချရသော ငွေပေးချေမှုစနစ်နှင့် ဒေတာကာကွယ်မှု</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-bolt fa-3x text-warning mb-3"></i>
                        <h5 class="card-title">မြန်ဆန်သော</h5>
                        <p class="card-text">ချက်ချင်းထိုး၊ ချက်ချင်းသိ၊ ချက်ချင်းထုတ်ယူနိုင်</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-headset fa-3x text-success mb-3"></i>
                        <h5 class="card-title">၂၄/၇ ဝန်ဆောင်မှု</h5>
                        <p class="card-text">နေ့ည မရွေး ဝန်ဆောင်မှုပေးနေသော ဝန်ထမ်းများ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- How to Play -->
<section class="how-to-play bg-light py-5 mb-5">
    <div class="container">
        <h2 class="text-center mb-4">ထီထိုးနည်း အဆင့်ဆင့်</h2>
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="text-center">
                    <div class="circle bg-primary text-white mb-3">1</div>
                    <h5>အကောင့်ဖွင့်ပါ</h5>
                    <p>အချက်အလက်များဖြည့်၍ အကောင့်အသစ်ဖွင့်ပါ</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="text-center">
                    <div class="circle bg-primary text-white mb-3">2</div>
                    <h5>ငွေဖြည့်ပါ</h5>
                    <p>သင့်အကောင့်သို့ ငွေဖြည့်သွင်းပါ</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="text-center">
                    <div class="circle bg-primary text-white mb-3">3</div>
                    <h5>နံပါတ်ရွေးပါ</h5>
                    <p>သင်နှစ်သက်ရာ နံပါတ်များကို ရွေးချယ်ပါ</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="text-center">
                    <div class="circle bg-primary text-white mb-3">4</div>
                    <h5>ထီပေါက်စဉ်စစ်ပါ</h5>
                    <p>ထီပေါက်စဉ်ထွက်ချိန်တွင် စစ်ဆေးပါ</p>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin: 0 auto;
}

.hero {
    background: linear-gradient(135deg, #4a90e2 0%, #2c5282 100%);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const setLoadingState = (loading = true) => {
        const elements = ['latest2D', 'latest2DTime', 'latest3D', 'latest3DTime'];
        elements.forEach(id => {
            const el = document.getElementById(id);
            if (loading) {
                el.classList.add('text-muted');
                if (id.includes('Time')) {
                    el.textContent = 'Loading...';
                } else {
                    el.textContent = id.includes('2D') ? '--' : '---';
                }
            } else {
                el.classList.remove('text-muted');
            }
        });
    };

    const setErrorState = (error) => {
        const elements = {
            'latest2D': '--',
            'latest2DTime': error,
            'latest3D': '---',
            'latest3DTime': error
        };
        Object.entries(elements).forEach(([id, text]) => {
            const el = document.getElementById(id);
            el.textContent = text;
            el.classList.add('text-danger');
        });
    };

    // Initial loading state
    setLoadingState(true);

    // Fetch latest results with retry
    const fetchResults = async (retries = 3) => {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch('/api/results/latest', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    setLoadingState(false);
                    document.getElementById('latest2D').textContent = data.results.twod || '--';
                    document.getElementById('latest2DTime').textContent = data.results.twod_time || 'No recent results';
                    document.getElementById('latest3D').textContent = data.results.threed || '---';
                    document.getElementById('latest3DTime').textContent = data.results.threed_time || 'No recent results';
                    return;
                } else if (data.error) {
                    throw new Error(data.message || 'Failed to load results');
                }
            } catch (error) {
                console.error(`Attempt ${i + 1} failed:`, error);
                if (i === retries - 1) {
                    setErrorState('Server is not responding. Please try again later.');
                } else {
                    // Wait before retrying (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }
    };

    fetchResults();

    // Refresh results every 5 minutes
    setInterval(() => fetchResults(1), 300000);
});
</script> 